<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chat Widget â€“ Demo & Install</title>
  <link rel="stylesheet" href="widget.css">
  <style>
    /* Landing/demo page styles (kept minimal, widget styles in widget.css) */
    body.demo-page {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      color: #0f172a;
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      min-height: 100vh;
    }
    .site-wrap { max-width: 1000px; margin: 0 auto; padding: 24px; }
    header.site-header { display:flex; align-items:center; justify-content:space-between; padding: 8px 0 16px; }
    .brand { display:flex; align-items:center; gap: 10px; font-weight: 700; font-size: 18px; }
    .brand .dot { width:10px; height:10px; border-radius:50%; background: #0072ff; box-shadow: 0 0 0 3px rgba(0,114,255,0.15); }
    .hero { padding: 32px 0; }
    .hero h1 { margin: 0 0 8px; font-size: 32px; }
    .hero p { margin: 0; color: #475569; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 20px; margin-top: 24px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    .card { background:#fff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 16px rgba(2,6,23,0.04); }
    .card h2 { margin: 0; font-size: 18px; }
    .card .hd { display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom:1px solid #f1f5f9; }
    .card .bd { padding: 16px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background:#0f172a; color:#e2e8f0; padding: 12px; border-radius: 8px; overflow:auto; border:1px solid #334155; }
    .actions { display:flex; gap:8px; }
    button.copy-btn { appearance: none; border: 1px solid #cbd5e1; background:#fff; color:#0f172a; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
    button.copy-btn:active { transform: translateY(1px); }
    .muted { color:#64748b; font-size: 13px; }
    footer.site-footer { margin-top: 32px; padding: 16px 0; color:#64748b; font-size: 13px; }
    .demo-note { background:#f8fafc; border:1px dashed #cbd5e1; color:#475569; padding:10px 12px; border-radius:8px; font-size:13px; }
  </style>
</head>
<body class="demo-page" data-api-url="http://localhost:3000/chat" data-brand="Powered by KodeKunal" data-brand-url="https://github.com/KodeKunal">
  <div class="site-wrap">
    <header class="site-header">
      <div class="brand"><span class="dot"></span> AI Chat Widget</div>
      <div class="muted">Drop-in chat for any site</div>
    </header>

    <section class="hero">
      <h1>Plug-and-play AI chat widget</h1>
      <p>Add a floating chat bubble to any website in seconds. Works with your backend at <code>/chat</code>.</p>
    </section>

    <section class="grid">
      <div class="card">
        <div class="hd"><h2>Live demo</h2></div>
        <div class="bd">
          <p class="demo-note">Click the blue chat bubble at the bottom-right to open the widget and try it.</p>
        </div>
      </div>
      <div class="card">
        <div class="hd">
          <h2>Install in your site</h2>
          <div class="actions">
            <button class="copy-btn" data-copy="embed-html">Copy</button>
          </div>
        </div>
        <div class="bd">
<pre class="kbd" id="embed-html">&lt;!-- 1) Include widget styles and script --&gt;
&lt;link rel="stylesheet" href="/path/to/widget.css" /&gt;
&lt;script src="/path/to/widget.js"&gt;&lt;/script&gt;

&lt;!-- 2) Initialize the widget anywhere after &lt;body&gt; --&gt;
&lt;script&gt;
  initAIChatWidget({
    apiUrl: 'http://localhost:3000/chat', // change to your deployed API
    position: 'right',                    // 'right' | 'left'
    theme: '#2196f3'                      // accent color
  });
&lt;/script&gt;</pre>
          <p class="muted" style="margin-top:8px">Copy <code>widget.css</code> and <code>widget.js</code> into your project and update the paths above.</p>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:20px;">
      <div class="hd"><h2>Backend contract</h2></div>
      <div class="bd">
        <p class="muted">The widget calls your API with either POST JSON or GET query param:</p>
<pre class="kbd">POST /chat
Content-Type: application/json

{ "message": "Hello" }

// or (fallback)
GET /chat?message=Hello

// Expected response (JSON or plain text):
{ "reply": "Hi there!" }
</pre>
      </div>
    </section>

    <footer class="site-footer">
      Tip: You can also set attributes on &lt;body&gt; to configure the widget without code:
      <code>data-api-url</code>, <code>data-brand</code>, <code>data-brand-url</code>.
    </footer>
  </div>
  <!-- AI Chat Widget -->
  <div class="ai-chat-widget">
    <button class="ai-chat-button" aria-label="Open chat widget">ðŸ’¬</button>
  </div>

  <div class="ai-chat-container" aria-live="polite" aria-hidden="true">
    <div class="ai-chat-header">
      <div class="header-content">
        <span class="ai-logo">ðŸ¤–</span>
        <strong>AI Assistant</strong>
      </div>
      <button class="ai-chat-close" aria-label="Close chat">âœ•</button>
    </div>

    <div class="ai-chat-messages" id="aiChatMessages">
      <div class="ai-chat-message bot">Hi! How can I help you today?</div>
    </div>

    <div class="ai-chat-input">
      <input id="aiMessageInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="aiSendBtn" aria-label="Send message">âž¤</button>
    </div>

    <div class="ai-chat-footer">
      <i>âœ¨</i><span>Ask me anything</span>
    </div>

    <div class="ai-chat-branding" id="aiChatBranding" role="contentinfo" aria-label="Branding">Powered by AI Chatbot</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Simple copy buttons for code blocks
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-copy');
          const el = document.getElementById(id);
          if (!el) return;
          const txt = el.innerText;
          navigator.clipboard.writeText(txt).then(() => {
            const old = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = old, 1200);
          });
        });
      });

      const openBtn = document.querySelector('.ai-chat-button');
      const container = document.querySelector('.ai-chat-container');
      const closeBtn = document.querySelector('.ai-chat-close');
      const input = document.getElementById('aiMessageInput');
      const sendBtn = document.getElementById('aiSendBtn');
      const messagesEl = document.getElementById('aiChatMessages');
  const brandEl = document.getElementById('aiChatBranding');

      const toggle = (show) => {
        const active = show ?? !container.classList.contains('active');
        container.classList.toggle('active', active);
        container.setAttribute('aria-hidden', (!active).toString());
        if (active) input?.focus();
      };

      const scrollToBottom = () => { messagesEl.scrollTop = messagesEl.scrollHeight; };

      // Config (override via <body data-*>)
      const cfg = {
        url: document.body.dataset.apiUrl || '/chat',
        method: (document.body.dataset.apiMethod || 'POST').toUpperCase(),
        field: document.body.dataset.apiField || 'message',
        auth: document.body.dataset.apiAuth || '',
        stream: (document.body.dataset.apiStream || '').toLowerCase(), // "sse" to force SSE
        withCredentials: document.body.dataset.apiCredentials === 'include'
      };

      // Branding (optional): set via <body data-brand="Powered by ..." data-brand-url="https://...">
      const brandText = document.body.dataset.brand || 'Powered by KodeKunal';
      const brandUrl = document.body.dataset.brandUrl || '';
      if (brandEl) {
        if (brandUrl) {
          brandEl.innerHTML = `<a href="${brandUrl}" target="_blank" rel="noopener noreferrer">${brandText}</a>`;
        } else {
          brandEl.textContent = brandText;
        }
      }

      const renderMessage = (text, role = 'user') => {
        const div = document.createElement('div');
        div.className = `ai-chat-message ${role}`;
        div.textContent = text;
        messagesEl.appendChild(div);
        scrollToBottom();
        return div;
      };

      // Helpers to extract reply and stream SSE
      const pickReply = (d) => {
        if (!d) return '';
        if (typeof d === 'string') return d;
        if (d.reply) return d.reply;
        if (d.answer) return d.answer;
        if (d.message) return d.message;
        if (d.output) return d.output;
        if (d.data?.reply || d.data?.answer || d.data?.message) return d.data.reply || d.data.answer || d.data.message;
        if (Array.isArray(d.choices) && d.choices[0]?.message?.content) return d.choices[0].message.content;
        if (Array.isArray(d.choices) && d.choices[0]?.delta?.content) return d.choices[0].delta.content;
        return '';
      };

      const streamSSE = async (res, onChunk) => {
        if (!res.body) return;
        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split(/\r?\n/);
          buffer = lines.pop() || '';
          for (const line of lines) {
            if (!line.startsWith('data:')) continue;
            const dataStr = line.slice(5).trim();
            if (!dataStr || dataStr === '[DONE]') continue;
            try {
              const obj = JSON.parse(dataStr);
              const chunk = pickReply(obj) || obj.delta || obj.content || '';
              if (chunk && onChunk) onChunk(chunk, true);
            } catch {
              if (onChunk) onChunk(dataStr, true);
            }
          }
        }
      };

      // Flexible API call with fallbacks and optional streaming
      const fetchAnswer = async (q, onChunk) => {
        const ctrl = new AbortController();
        const timeout = setTimeout(() => ctrl.abort(), 30000); // 30s timeout
        try {
          const headers = {
            'Accept': 'application/json, text/plain, text/event-stream'
          };
          if (cfg.method === 'POST') headers['Content-Type'] = 'application/json';
          if (cfg.auth) headers['Authorization'] = cfg.auth;

          const url = cfg.method === 'GET'
            ? `${cfg.url}?${encodeURIComponent(cfg.field)}=${encodeURIComponent(q)}`
            : cfg.url;

          const body = cfg.method === 'POST'
            ? JSON.stringify({
                [cfg.field]: q,
                // common aliases to maximize compatibility with various backends
                message: q, prompt: q, query: q, question: q, text: q, input: q
              })
            : undefined;

          const res = await fetch(url, {
            method: cfg.method,
            headers,
            body,
            signal: ctrl.signal,
            mode: 'cors',
            credentials: cfg.withCredentials ? 'include' : 'same-origin'
          });

          if (!res.ok) {
            let errText = '';
            try { errText = await res.text(); } catch {}
            throw new Error(`HTTP ${res.status}${errText ? ': ' + errText.slice(0, 200) : ''}`);
          }

          const ct = (res.headers.get('content-type') || '').toLowerCase();

          if (ct.includes('text/event-stream') || cfg.stream === 'sse') {
            // Stream chunks into the UI
            await streamSSE(res, onChunk);
            return ''; // final text already accumulated via onChunk
          }

          if (ct.includes('application/json')) {
            const data = await res.json();
            return pickReply(data) || '';
          }

          // Plain text fallback
          return await res.text();
        } catch (e) {
          // Fallback to GET if POST failed due to network/CORS
          if (cfg.method === 'POST') {
            try {
              const getUrl = `${cfg.url}?${encodeURIComponent(cfg.field)}=${encodeURIComponent(q)}`;
              const res = await fetch(getUrl, {
                method: 'GET',
                headers: { 'Accept': 'application/json, text/plain' },
                mode: 'cors',
                credentials: cfg.withCredentials ? 'include' : 'same-origin'
              });
              if (!res.ok) {
                let errText = '';
                try { errText = await res.text(); } catch {}
                throw new Error(`HTTP ${res.status}${errText ? ': ' + errText.slice(0, 200) : ''}`);
              }
              const ct = (res.headers.get('content-type') || '').toLowerCase();
              if (ct.includes('application/json')) {
                const data = await res.json();
                return pickReply(data) || '';
              }
              return await res.text();
            } catch (e2) {
              console.error('GET fallback error:', e2);
            }
          }
          console.error('Chat API error:', e);
          throw e;
        } finally {
          clearTimeout(timeout);
        }
      };

      const send = async () => {
        const text = (input.value || '').trim();
        if (!text) return;
        renderMessage(text, 'user');
        input.value = '';
        const thinking = renderMessage('Thinkingâ€¦', 'bot');

        let acc = '';
        const onChunk = (chunk) => {
          acc += chunk;
          thinking.textContent = acc;
        };

        try {
          const final = await fetchAnswer(text, onChunk);
          thinking.textContent = (final || acc || 'Sorry, I did not receive a response.').trim();
        } catch (e) {
          console.error('Send error:', e);
          thinking.textContent = (e && e.message) ? e.message.slice(0, 300) : 'Sorry, something went wrong. Please try again.';
        }
      };

      openBtn?.addEventListener('click', () => toggle(true));
      closeBtn?.addEventListener('click', () => toggle(false));
      sendBtn?.addEventListener('click', send);
      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });
    });
  </script>
</body>
</html>
